{% extends 'sales_hub/base.html' %}

{% block title %}Service Request #{{ service_request.id }} - YAS Sales Hub{% endblock %}

{% block header %}
<div class="flex items-center justify-between">
    <div>
        <p class="text-sm text-gray-500">Service Request</p>
        <h1 class="text-2xl font-semibold text-gray-900">#{{ service_request.id }} - {{ service_request.get_specific_service_display }}</h1>
        <p class="mt-1 text-sm text-gray-500">Created {{ service_request.created_at|date:"M d, Y H:i" }}</p>
    </div>
    <div class="flex items-center space-x-3">
        {% if service_request.status == 'pending' %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">Pending</span>
        {% elif service_request.status == 'in_progress' %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">In Progress</span>
        {% elif service_request.status == 'completed' %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">Completed</span>
        {% else %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">Cancelled</span>
        {% endif %}
        {% if service_request.is_high_priority %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">High Priority</span>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left: Details -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Customer & Service Info -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Customer & Service Details</h2>
            <dl class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <dt class="font-medium text-gray-500">Phone Number</dt>
                    <dd class="mt-1 text-gray-900">{{ service_request.phone_number }}</dd>
                </div>
                <div>
                    <dt class="font-medium text-gray-500">Service Type</dt>
                    <dd class="mt-1 text-gray-900">{{ service_request.get_service_type_display }}</dd>
                </div>
                <div>
                    <dt class="font-medium text-gray-500">Specific Service</dt>
                    <dd class="mt-1 text-gray-900">{{ service_request.get_specific_service_display }}</dd>
                </div>
                <div>
                    <dt class="font-medium text-gray-500">Timeline</dt>
                    <dd class="mt-1 text-gray-900">{{ service_request.get_timeline_display }}</dd>
                </div>
                <div>
                    <dt class="font-medium text-gray-500">Lead Score</dt>
                    <dd class="mt-1">
                        {% if service_request.lead_score >= 70 %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">{{ service_request.lead_score }}</span>
                        {% elif service_request.lead_score >= 40 %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">{{ service_request.lead_score }}</span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">{{ service_request.lead_score }}</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="font-medium text-gray-500">Contact for Offers</dt>
                    <dd class="mt-1 text-gray-900">{{ service_request.get_contact_preference_display }}</dd>
                </div>
                <div>
                    <dt class="font-medium text-gray-500">Assigned To</dt>
                    <dd class="mt-1 text-gray-900">
                        {% if service_request.assigned_to %}
                            {{ service_request.assigned_to.user.get_full_name|default:service_request.assigned_to.user.username }}
                        {% else %}
                            <span class="text-gray-400">Unassigned</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="font-medium text-gray-500">Status</dt>
                    <dd class="mt-1 text-gray-900">{{ service_request.get_status_display }}</dd>
                </div>
            </dl>
        </div>

        <!-- Notes / History -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Notes & History</h2>
            {% if service_request.notes %}
                <pre class="whitespace-pre-wrap text-sm text-gray-800 bg-gray-50 border border-gray-200 rounded-lg p-4 max-h-64 overflow-y-auto">{{ service_request.notes }}</pre>
            {% else %}
                <p class="text-sm text-gray-500">No notes yet. Use the form on the right to add your first update.</p>
            {% endif %}
        </div>
    </div>

    <!-- Right: Actions -->
    <div class="space-y-6">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Take Action</h2>
            <form method="post" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% for value,label in service_request.STATUS_CHOICES %}
                            <option value="{{ value }}" {% if value == service_request.status %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="flex items-center">
                    <input id="assign_to_me" name="assign_to_me" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                    <label for="assign_to_me" class="ml-2 block text-sm text-gray-700">Assign to me</label>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Add Note</label>
                    <textarea name="note" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="What did you do for this customer?"></textarea>
                </div>

                <div class="flex justify-between items-center pt-2">
                    <a href="{% url 'sales_hub:service_requests' %}" class="text-sm text-gray-600 hover:text-gray-800">&larr; Back to list</a>
                    <button type="submit" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow hover:bg-blue-700 focus:outline-none">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
